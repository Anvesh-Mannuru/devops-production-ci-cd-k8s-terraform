name: CI / CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  packages: write
  id-token: write
  pull-requests: write

env:
  BACKEND_DIR: app/api-service
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/api-service

jobs:
  test:
    name: Run tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.BACKEND_DIR }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run pytest
        run: python -m pytest -q

  build-and-push:
    name: Build and push image to GHCR
    needs: test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.BACKEND_DIR }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set image tag
        id: meta
        run: |
          echo "TAG=${GITHUB_SHA::8}" >> $GITHUB_ENV
          echo "FULL_IMAGE=${IMAGE_NAME}:${GITHUB_SHA::8}" >> $GITHUB_ENV

      - name: Log in to GitHub Container Registry (GHCR)
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Docker image
        run: docker build -t ${{ env.FULL_IMAGE }} .

      - name: Push Docker image
        run: docker push ${{ env.FULL_IMAGE }}

      - name: Show pushed image
        run: echo "Image pushed: ${{ env.FULL_IMAGE }}"

  deploy:
    name: Deploy to Kubernetes (prod)
    needs: build-and-push
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Configure KUBECONFIG
        run: |
          echo "${{ secrets.KUBECONFIG }}" | base64 --decode > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Show cluster info
        run: kubectl cluster-info

      - name: Apply kustomize (prod)
        run: kubectl apply -k k8s/overlays/prod

      - name: Update image to latest build
        run: |
          kubectl set image -k k8s/overlays/prod "*=${{ env.FULL_IMAGE }}" --record || true

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/api-service --timeout=120s || \
            echo "Rollout not complete â€” check logs"

      - name: Get running pods
        run: kubectl get pods -o wide -l app=api-service || kubectl get pods -o wide
